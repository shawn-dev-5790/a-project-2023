import Head from 'next/head'
import ui from '@/styles/page_mvp_showcase.module.scss'
import useSWR from 'swr'
import { useState } from 'react'
import { onfetch } from '@/helpers'
import SidePanel from './components/side_panel'

export default function PageMVPShowcase() {
  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name='description' content='Generated by create next app' />
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='icon' href='/favicon.ico' />
      </Head>
      <div className={ui.page_mvp_showcase}>
        <Header />
        <Main />
        <Footer />
      </div>
    </>
  )
}

function Header() {
  return (
    <header>
      <h1>Welcome to visit our workplace for MVP 2023</h1>
    </header>
  )
}
function Footer() {
  const link = {
    vercel: 'https://vercel.com/shawndev5790-gmailcom/a-project-2023/HpApdv4QicanWP8VpZE1K2r41PkM',
    github: 'https://github.com/shawn-dev-5790/a-project-2023',
  }
  return (
    <footer>
      <a href={link.vercel} target='_blank' rel='noopener noreferrer'>
        visit vercel
      </a>
      <a href={link.github} target='_blank' rel='noopener noreferrer'>
        visit github
      </a>
    </footer>
  )
}
function Main() {
  //   const { data, error, isLoading, isValidating } = useSWR<any, any>(() => '/api/getShowcaseList', onfetch)
  const { data, error, isLoading, isValidating } = useSWR<any, any>(() => '/api/display_list', onfetch)
  const currency = new Intl.NumberFormat('ko', { style: 'currency', currency: 'KRW' })
  const number = new Intl.NumberFormat('ko', {})
  const onErrorImg = (e: any) => {
    e.target.src = 'https://dummyimage.com/200x200/efefef/444444.png&text=no-image'
  }
  const list = data?.data.data || []
  const getPercent = (value: number, fieldname: string) => {
    const targets = list.map((item: { [k: string]: any }) => item[fieldname])
    const min = Math.min(...targets)
    const max = Math.max(...targets)
    const per = Math.ceil(((value - min) / max) * 100)
    return per
  }
  return (
    <>
      <main>
        <section className={ui.control}>
          <div className={ui.suggestion_list}>
            <strong>ì¶”ì²œ ì •ë ¬ ëª©ë¡</strong>
            <ul>
              <li>
                <span className={ui.wrap_img}>
                  <img
                    loading='lazy'
                    src={'https://dummyimage.com/120x120/F9FFA8/000000.png&text=+ECPM+'}
                    alt={`image of ECPM`}
                    onError={onErrorImg}
                  />
                </span>
                <div>
                  <b>ECPM ì§€í‘œ ê¸°ë°˜ìœ¼ë¡œ ìƒí’ˆì„ ë…¸ì¶œí•˜ì„¸ìš”!</b>
                  <p>ECPM ì§€í‘œëŠ” 1,000ë²ˆ ë…¸ì¶œìˆ˜ ëŒ€ë¹„ ê¸°ëŒ€êµ¬ë§¤ê¸ˆì•¡ì„ ì˜ë¯¸í•´ìš”</p>
                  <p>ë‹¤ë¥¸ ì§€í‘œë“¤ê³¼ ë¹„êµí•˜ì„¸ìš” (ë…¸ì¶œìˆ˜, êµ¬ë§¤ê±´ìˆ˜, ECPM)</p>
                  <p>ë‹¤ë¥¸ ìƒí’ˆë“¤ê³¼ ë¹„êµí•˜ì„¸ìš” (ECPM ë°±ë¶„ìœ¨ í™˜ì‚°)</p>
                </div>
              </li>
            </ul>
          </div>
        </section>
        <section className={ui.preview}>
          <div className={ui.preview_head}>
            <strong>ë¯¸ë¦¬ë³´ê¸°</strong>
            <p>ì¶”ì²œëœ ì •ë ¬ ë°©ì‹ì— ë”°ë¥¸ ë¯¸ë¦¬ë³´ê¸° í™”ë©´ì„ ì œê³µí•©ë‹ˆë‹¤</p>
          </div>
          {isLoading && 'loading...'}
          <ul className={ui.preview_items}>
            {list.map((item: any, idx: number) => (
              <li key={`${item.item_id}-${item.sequence_no}`}>
                <span className={ui.preview_img}>
                  <img
                    className={ui.g_img}
                    loading='lazy'
                    src={item.main_item_img}
                    alt={`image of ${item.item_name}`}
                    onError={onErrorImg}
                  />
                </span>
                <div className={ui.preview_info}>
                  <div>idx:{idx}</div>
                  <div className={'g_ellipsis_2'}>{item.item_name}</div>
                  <div>{currency.format(item.selling_price)}</div>
                  <div>ecpm={item.ecpm.toFixed(0)}</div>
                  <div>ecpm_per={getPercent(item.ecpm, 'ecpm')}%</div>
                  <div>ë…¸ì¶œìˆ˜={number.format(item.imp_cnt)}</div>
                  <div>view_cvr={number.format(item.view_cvr)}</div>
                  <div>êµ¬ë§¤ê±´ìˆ˜={number.format(item.conversion_cnt)}</div>
                </div>
              </li>
            ))}
          </ul>
        </section>
        <section className={ui.preview}>
          <div className={ui.preview_head}>
            <strong>ì •ë ¬ëœ ìƒí’ˆ ì§„ì—´ ë¯¸ë¦¬ë³´ê¸°</strong>
            <p>ì¶”ì²œëœ ì •ë ¬ ë°©ì‹ì— ë”°ë¥¸ ë¯¸ë¦¬ë³´ê¸° í™”ë©´ì„ ì œê³µí•©ë‹ˆë‹¤</p>
          </div>
          {isLoading && 'loading...'}
          <ul className={ui.preview_items}>
            {list
              .map((i: any, idx: number) => ({ ...i, idx }))
              .sort((a: any, b: any) => {
                return b['ecpm'] - a['ecpm']
              })
              .map((item: any, tdx: number) => (
                <li key={`${item.item_id}-${item.sequence_no}`}>
                  <span className={ui.preview_img}>
                    <img
                      className={ui.g_img}
                      loading='lazy'
                      src={item.main_item_img}
                      alt={`image of ${item.item_name}`}
                      onError={onErrorImg}
                    />
                  </span>
                  <div className={ui.preview_info}>
                    <div>
                      idx:{item.idx} ğŸ”€ {tdx}
                    </div>
                    <div className={'g_ellipsis_2'}>{item.item_name}</div>
                    <div>{currency.format(item.selling_price)}</div>
                    <div>ecpm={item.ecpm.toFixed(0)}</div>
                    <div>ecpm_per={getPercent(item.ecpm, 'ecpm')}%</div>
                    <div>ë…¸ì¶œìˆ˜={number.format(item.imp_cnt)}</div>
                    <div>view_cvr={number.format(item.view_cvr)}</div>
                    <div>êµ¬ë§¤ê±´ìˆ˜={number.format(item.conversion_cnt)}</div>
                  </div>
                </li>
              ))}
          </ul>
        </section>
        <SidePanel />
      </main>
    </>
  )
}
